# Bingo (Итоговый проект тренировок DevOps Y&Y)

## Содержание:
1. Как запускал и разбирался, с чем готовил и с чем ел
2. Итоги и выводы для себя
3. Примечания

## Как запускал и разбирался, с чем готовил и с чем ел

В первую очередь, создал виртуалку в Я.Облаке, чтобы потыкать программу. Для удобства работы, сразу добавил директорию в $PATH `export PATH=$PATH:/home/ubuntu/Bingo/`

По опыту второй домашки, где у меня случился затык с [unified_agent](https://cloud.yandex.ru/blog/posts/2021/03/unified-agent-preview), из-за того что я в первый раз его видел, и слабо понимал чего он умеет и хочет, я решил не бежать вперед паровоза с автоматизацией. Сначала сделаю все полностью рабочее руками, проверю результаты у Пети, где-то что-то поправлю, и уже буду автоматизировать.

Понял, что `bingo print_default_config` показывает конфиг, а откуда он берет current не понял. Пошел проверять через `strace bingo print_current_config`. Обнаружил, что в `/opt/bingo/config.yaml`. Хотел облегчить себе жизнь, поэтому создал симлинк на директорию с самим Bingo. `ln -s /home/ubuntu/Bingo/config.yaml /opt/bingo/config.yaml`. Не сразу осознал, что так я наоборот сделал костыль, и стоило просто закинуть бинарь в `/opt`. Но, 1. зато честно, 2. конфиг будет видно в репозитории, 3. мне просто так удобнее. В проде, или если что-то сломается, обязательно исправлю!

Пошел делать кластер PostgreSQL из двух хостов, тоже в Я.Облаке, и тоже руками. На всякий, дал мастер хосту публичный доступ, потому что на этом этапе не знаю, нужен ли Пете доступ к БД, и где он сидит.

Вписал в `сonfig.yaml` данные от БД, проверил через `print_current_config`, запустил `prepare_db`, пошел заваривать чай, и запустил `bingo run_server`. Вылезла ошибка `panic: failed to build logger`. Что за логгер? Вывод `strace bingo run_server` показал `.../opt/bongo/logs/5312f91e13/main.log...(No such file or directory)`. Сначала я решил тупо создать директорию, мало ли сервис сам не умеет, но ошибка оказалась той же. И только потом я увидел, что эти логи находятся не в /b**i**ngo, а в b**o**ngo, а выше есть ошибка `EPERM (Operation not permitted)`, и сразу побежал делать `chown -R ubuntu:ubuntu /opt/bongo/`. Все работает!

Думал отправлять запросы `curl`, но решил попробовать Postman, потому что давно хотел его изучить, а руки не доходили. Перезапустил bingo используя `nohup bingo run_server &`, чтобы узнать порт через `ss -tulp`. Узнал, что это :32862. В логах `nohup.out` узнал, что сервис реально запустился! `code:         yoohoo_server_launched`, и в Postman летят ответы на мои запросы. Приятно!
А вот то, что сервис через какое-то время начал отвечать на любые запросы "I feel bad" - не очень. Еще и выбурается с ошибкой "We're all gonna die" (или что то в этом роде). Разберемся с этим чуть позже.

Так как пока не знаю, и не понимаю что это у него за ошибки, решил сделать [systemd сервис](/bingo.service), чтобы bingo перезапускался сам

Сейчас я запускаю вторую ноду и network load balancer. Запустил, и отправляю в первый раз Пете на проверку. Ожидал худшего, результат:

<img width="465" alt="ПЕРВЫЙ ПЕТЯ!!!" src="https://github.com/M2l2koPOWER/bingo-y-y/assets/23089294/122e06f5-48f2-497c-95d6-0d2842e5d2a5">


Понял, что без Nginx я никак не сделаю кэширование и https, потому что ALB хочет статический IP, а NLB походу не может вообще. Решил сделать третью виртуалку чисто под Nginx.

Пошел изучать как сделать http3, нашел что надо собрать nginx самому. Это было то самое приключение на 20 минут... В итоге смог собрать, используя официальную доку. Использовал: `boringssl nginx-1.25.3 ngx_brotli`. Вообщем, домен подцепил, http3 включил, кеш на /long_dummy включил. [Конфиг файлы прикрепляю](/nginx/). Но Петя почему-то галочек не дал, хотя в браузере и h3 был, и кэширование, и ssl. 

Не понял, как ускорить старт. Поэтому просто добавил железа, на всякий сделал swap, `dirty_ratio=30` и `dirty_background_ratio=15`  и нагуглил `prelink` и `preload`. Особо не помогло, просто получил галку "Отказоустойчивость 2".

До дедлайна осталось 3 часа, а я только дописываю это. Так и не смог ничего придумать, и даже решить проблему с https (если она вообще была).

## Итоги и выводы для себя

На самом деле, это был отличный опыт, который подчеркнул пробелы в знаниях, а именно: определенно мне нужно больше времени потратить на изучение БД, потому что я смог нагуглить, что можно сделать индексацию, но как это сделать правильно - абсолютно не понял. Туда же идет более глубокое изучение Линуксов, потому что я уверен, что `bingo` в себе несет еще какие-то секреты, которые можно было бы найти даже используя ВСЕ инструменты из третьей лекции, но я про них и не вспомнил. 

Жаль, что я сильно отложил выполнение проекта, и не успел сделать автоматизацию, но по крайней мере у меня получилось все это запустить, получить опыт, прокачать опыт чтения документации, и опыт работы без документации. Ну а самое важное, этот проект показал мне точки роста, над которыми я буду работать. Очен хотелось развернуть это все через ТФ, да и обернуть в Докер, но как вышло.
Все еще нужно найти ответы на следующие вопросы: 1. как ускорить старт? 2. как ускорить некоторые запросы? (как бы я не растил железо, время не падало вообще) 3. на каком месте bingo просто дохнет?

И спасибо всем причастным за лекции, за проект, и вообще за все! Если кто-то из участников будет это читать, то хочу вам сказать, что не так важно как в итоге вы закончили, важно только то, что вы подчерпнули в процессе. <3

Итог от Пети: 

<img width="319" alt="ПЕТЯ ИТОГ" src="https://github.com/M2l2koPOWER/bingo-y-y/assets/23089294/89033922-61cb-4380-9cd8-18334ddbb9e0">


## Примечания

1. Nginx собирал так: 

`./configure \
        --prefix=/etc/nginx \
        --sbin-path=/usr/sbin/nginx \
        --with-openssl=../openssl \
        --conf-path=/etc/nginx/nginx.conf \
        --http-log-path=/var/log/nginx/access.log \
        --error-log-path=/var/log/nginx/error.log \
        --with-pcre  \
        --lock-path=/var/lock/nginx.lock \
        --pid-path=/var/run/nginx.pid \
        --with-http_ssl_module \
        --with-http_image_filter_module=dynamic \
        --modules-path=/etc/nginx/modules \
        --with-http_v2_module \
        --with-stream=dynamic \
        --with-http_addition_module \
        --with-http_mp4_module  \
        --add-module=../ngx_brotli \
        --build=nginx --with-debug  \
        --with-http_v3_module \
        --with-cc-opt="-I/home/ubuntu/boringssl/build/boringssl/include" --with-ld-opt="-L/home/ubuntu/boringssl/build/ssl -L/home/ubuntu/boringssl/build/crypto" && \
    sudo make && sudo make install`
